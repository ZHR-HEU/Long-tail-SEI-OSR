# 🚀 两阶段长尾开集训练 - 快速上手

## 一、最快上手方式（3步）

### 1️⃣ 检查数据路径

```bash
# 确认数据文件存在
ls -lh /home/dell/md3/zhahaoran/data/*.mat
```

如果路径不对，编辑配置文件：
```bash
vim config_openset_twostage.yaml
# 修改第29-30行的 path_train 和 path_test
```

### 2️⃣ 直接运行

```bash
python train_openset_twostage.py
```

### 3️⃣ 查看结果

```bash
# 训练完成后查看最终结果
cat checkpoints/stage2/final_results.txt
```

---

## 二、训练过程说明

### 训练流程

```
开始
  ↓
Stage 1: 表示学习（约30-60分钟）
  - 只在已知类上训练
  - 学习好的特征表示
  - 保存backbone模型
  ↓
Stage 2: 分类器重训练 + 开集检测（约30-60分钟）
  - 冻结backbone
  - 重新训练分类器（处理长尾）
  - 训练开集检测器
  - 保存最终模型
  ↓
完成！查看结果
```

### 预期训练时间

- **GPU (RTX 3090)**: 1-2小时
- **GPU (GTX 1080)**: 2-4小时
- **CPU**: 8-12小时（不推荐）

---

## 三、核心配置参数

### 必须修改的参数

```yaml
# config_openset_twostage.yaml

data:
  path_train: "你的训练数据.mat"     # ← 必须修改
  path_test: "你的测试数据.mat"      # ← 必须修改
  num_known_classes: 6               # ← 根据数据集调整
```

### 常用调整参数

```yaml
# 如果显存不足
data:
  batch_size: 128    # 默认256，改小

# 如果训练太慢
stage1:
  epochs: 100        # 默认200，减少
stage2:
  epochs: 100
```

---

## 四、常见命令

### 基础运行

```bash
# 使用默认配置运行
python train_openset_twostage.py

# 指定配置文件
python train_openset_twostage.py --config config_openset_twostage.yaml
```

### 后台运行（推荐长时间训练）

```bash
# 方式1: 使用 nohup
nohup python train_openset_twostage.py > training.log 2>&1 &

# 查看实时日志
tail -f training.log

# 方式2: 使用 tmux（推荐）
tmux new -s train
python train_openset_twostage.py
# 按 Ctrl+B 然后按 D 分离会话
# 重新连接: tmux attach -t train
```

### 监控训练

```bash
# 实时查看日志
tail -f training.log

# 查看GPU使用情况
nvidia-smi

# 查看进程
ps aux | grep train_openset_twostage
```

---

## 五、输出文件说明

### 目录结构

```
checkpoints/
├── stage1/
│   └── best_model.pth          ← Stage-1最佳模型
└── stage2/
    ├── best_model.pth          ← 最终模型（用这个！）
    └── final_results.txt       ← 测试结果（看这个！）
```

### 关键结果指标

```
final_results.txt 中的指标：

Closed-Set Performance:
  Closed-Set Accuracy: 0.7856    ← 已知类准确率（越高越好，目标>75%）

Open-Set Performance:
  AUROC: 0.8912                  ← 开集检测能力（越高越好，目标>85%）
  OSCR: 0.8123                   ← 综合指标（越高越好，目标>75%）

Long-Tail Analysis:
  Many-shot Acc: 0.8945          ← 头部类准确率
  Few-shot Acc: 0.6234           ← 尾部类准确率（差距越小越好）
```

---

## 六、快速调优指南

### 问题1: 显存不足（CUDA out of memory）

```yaml
data:
  batch_size: 64     # 改小（原来是256）
```

### 问题2: 开集检测效果差（AUROC < 0.7）

```yaml
# 尝试不同的检测器
stage2:
  openset:
    detector_type: "odin"    # 改成 odin 或 energy

# 或增加训练轮数
stage1:
  epochs: 300
```

### 问题3: 尾部类准确率低（Few-shot Acc < 0.5）

```yaml
# 使用更强的重采样
stage2:
  sampling_strategy: "class_uniform"  # 完全平衡采样

# 使用代价敏感损失
stage2:
  loss:
    name: "CostSensitiveCE"
```

### 问题4: 训练太慢

```yaml
# 减少轮数（快速实验）
stage1:
  epochs: 50
stage2:
  epochs: 50

# 增大batch size（如果显存够）
data:
  batch_size: 512
  num_workers: 8
```

---

## 七、完整运行示例

```bash
# 1. 进入项目目录
cd /home/user/Long-tail-SEI-OSR

# 2. 检查数据路径
grep "path_train\|path_test" config_openset_twostage.yaml

# 3. 启动训练（后台运行）
nohup python train_openset_twostage.py > training.log 2>&1 &

# 4. 查看训练进度（另开终端）
tail -f training.log

# 5. 训练完成后查看结果
cat checkpoints/stage2/final_results.txt

# 6. 如果要停止训练
# 查找进程ID
ps aux | grep train_openset_twostage
# 杀死进程
kill <进程ID>
```

---

## 八、不同场景的配置建议

### 场景A: 快速测试（10分钟跑完）

```yaml
stage1:
  epochs: 10
stage2:
  epochs: 10
```

### 场景B: 标准训练（1-2小时）

```yaml
stage1:
  epochs: 200
stage2:
  epochs: 200
```

### 场景C: 追求最高性能（3-4小时）

```yaml
stage1:
  epochs: 300
  diffusion:
    enabled: true
stage2:
  epochs: 300
  openset:
    detector_type: "openmax"
```

---

## 九、常见错误快速解决

| 错误信息 | 解决方法 |
|---------|---------|
| `FileNotFoundError: *.mat` | 修改配置文件中的数据路径 |
| `Unknown norm kind: batch_norm` | 改为 `norm_kind: "auto"` |
| `CUDA out of memory` | 减小 batch_size 到 64 或 128 |
| `No module named 'xxx'` | `pip install xxx` |
| `Training too slow` | 改用GPU，增加 num_workers |
| `AUROC too low` | 增加训练轮数，换检测器 |

---

## 十、获取帮助

### 查看详细文档
```bash
cat RUN_GUIDE.md        # 详细运行指南
cat README.md           # 项目说明
```

### 检查代码
```bash
# 查看训练脚本帮助
python train_openset_twostage.py --help

# 查看配置文件
cat config_openset_twostage.yaml
```

---

## 🎉 开始你的第一次训练！

```bash
# 就这一条命令！
python train_openset_twostage.py
```

**预计训练时间**: 1-2小时 (GPU)
**预期准确率**: Closed-Set Acc > 75%, AUROC > 85%

🚀 **祝训练成功！**
